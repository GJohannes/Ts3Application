<html>
<head>
<title>Private Message Dialog</title>
<style>
.bg {
	/* The image used */
	background-image: url("/../images/MessageBackground.jpg");
	/* Full height */
	height: 100%;
	/* Center and scale the image nicely */
	background-position: center;
	background-repeat: no-repeat;
	background-size: cover;
}

.divMainMessage {
	background-color: lightblue;
	margin: auto;
	width: 50%;
	text-align: center;
}

body {
	margin: 0;
}
</style>
</head>
<body>
	<div class="bg">
		<div class="divMainMessage">
			<h1 id="headLine"></h1>
			<div>
				<input id="messageToServer">Type your chat text here
			</div>
			<div>
				<textarea style="width: 100%; height: 100%; resize: none;" rows="4" readonly id="chatBox">Chat Messages:</textarea>
			</div>
			<div class="divCenter">
				<a href="/../impressum.html"> Impressum </a>
			</div>
		</div>
	</div>
</body>
<script src="/../../javascript/jquery-3.3.1.js"></script>
<link rel="stylesheet" type="text/css" href="/../css/overallCSS.css">
<script type="text/javascript">
	$(document).ready(function() {
		var url_string = window.location.href; //window.location.href
		var url = new URL(url_string);
		var c = url.searchParams.get("User");
		document.getElementById("headLine").innerHTML = "Chatroom with " + c;
		updateChatBox();
		console.log(c + " is the chat partner");
		refreshMessages();
	})

	$(function() {
		$("#messageToServer").keypress(function(e) {
			var code = e.keyCode;
			if (code == 13) {
				sendMessageToServer();
				document.getElementById("messageToServer").value = "";
				return true;
			}
		});
	});

	function getURLparam() {
		var url_string = window.location.href; //window.location.href
		var url = new URL(url_string);
		var c = url.searchParams.get("User");
		console.log(c);
		return c;
	}

	function refreshMessages() {
		setInterval(function() {
			updateChatBox();
		}, 1000);
	}

	/*
	 * update method similar to sendMessageAndUpdate 
	 */
	function updateChatBox() {
		$.ajax({
			url : '/updatePrivateChatBoxes',
			type : 'POST',
			dataType : 'json',
			data : JSON.stringify({
				"teamspeakUser" : getURLparam(),
			}),
			success : function(data) {
				if (data.personExisting === "false") {
					return;
				}
				var textOfChatBox = $("textarea#chatBox");
				document.getElementById("chatBox").value = "Chat Messages:";
				var messagesToDisplay = JSON.parse(data.chatContent);
				console.log(messagesToDisplay.length)
				console.log(messagesToDisplay);

				for (i = 0; i < messagesToDisplay.length; i++) {
					textOfChatBox.val(textOfChatBox.val() + "\n"
							+ messagesToDisplay[i]);
				}

				console.log(textOfChatBox);
				console.log("success on ajax call message to server");
			},
			failure : function(data) {
				console.log("ERROR!!!");
				console.log(data);
			}
		})
	}

	function sendMessageToServer() {
		$
				.ajax({
					url : '/privateMessage',
					type : 'POST',
					dataType : 'json',
					data : JSON
							.stringify({
								"message" : document
										.getElementById("messageToServer").value,
								"teamspeakUser" : getURLparam(),
							}),
					success : function(data) {
						var textOfChatBox = $("textarea#chatBox");
						console.log(data.personExisting);
						if (data.personExisting === "false") {
							textOfChatBox
									.val(textOfChatBox.val()
											+ "\n "
											+ getURLparam()
											+ " is not currently on the teamspeak Server or has gone offline");
							return;
						}

						document.getElementById("chatBox").value = "Chat Messages:";
						var messagesToDisplay = JSON.parse(data.chatContent);
						console.log(messagesToDisplay.length);
						console.log(messagesToDisplay);

						for (i = 0; i < messagesToDisplay.length; i++) {
							textOfChatBox.val(textOfChatBox.val() + "\n"
									+ messagesToDisplay[i]);
						}

						console.log(textOfChatBox);
						console.log("success on ajax call message to server");
					},
					failure : function(data) {
						console.log("ERROR!!!");
						console.log(data);
					}
				})
	}
</script>